<html lang="en">
<head>
        <meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
        <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.CANVAS, '', { preload: preload, create: create, update: update, render: render  });

var bullet;
var powerBar;
var powerTween;
var bulletSpeed;
var GameState = function(game) {
};


function preload() {
     game.load.image('background', 'assets/szenen/bg_desert.png');
     game.load.image('cannon', 'assets/objects/canon/canon_base.png');
     game.load.image('canon_barrel', 'assets/objects/canon/canon_barrel.png');
     game.load.image('platform', 'assets/platform.png');
     game.load.image('sloth', 'assets/objects/sloth.png');
     game.load.image('star', 'assets/star.png');
     game.load.image('beanbag', 'assets/objects/beanbag/beanbag_red_small.png')


}


function create() {

    game.physics.startSystem(Phaser.Physics.ARCADE);

    game.world.setBounds(0, 0, 3840, 0);

    bg = game.add.tileSprite(0, 0, game.stage.bounds.width, 600, 'background');
    bg.fixedToCamera=true;


    this.GRAVITY = 300;
    game.physics.arcade.gravity.y = this.GRAVITY;

    this.gun = this.game.add.sprite(50, this.game.height - 100, 'cannon');
    this.gun.anchor.setTo(0.5,0.5);
    this.gun.scale.x = 0.25;
    this.gun.scale.y = 0.25;
    this.game.world.bringToTop(this.gun);

    this.gun2 = game.add.sprite(80, game.height - 110, 'canon_barrel');
    this.gun2.anchor.setTo(0.1, 0.5);
    this.gun2.scale.x = 0.25;
    this.gun2.scale.y = 0.25;


    groundBlock = this.game.add.sprite(0, this.game.height - 64, 'platform');
    groundBlock.scale.setTo(this.game.width, 2);
    this.game.physics.enable(groundBlock, Phaser.Physics.ARCADE);

    groundBlock.body.immovable = true;
    groundBlock.body.allowGravity = false;
    game.physics.arcade.enable(groundBlock);


    bullet = this.game.add.sprite(0.5, 0.5, 'sloth');
    bullet.scale.x = 0.05;
    bullet.scale.y = 0.05;
    
    bullet.rotation = game.physics.arcade.angleToPointer(bullet);


    this.NUMBER_OF_BULLETS = 1;
    bullet.anchor.setTo(0.5, 0.5);
    this.game.physics.enable(bullet);
    bullet.body.collideWorldBounds = false;
    bullet.body.bounce.setTo(0.7, 0.7);
    bullet.kill();

    beanbags = game.add.group();
    beanbags.enableBody = true;
    game.physics.enable(beanbags);
    for (var i = 0; i < 6; i++ ){
     game.add.sprite(1000+i*100, this.game.height - 120,'beanbag');
        
        beanbags.scale.x = 0.05;
        beanbags.scale.y = 0.05;
    }
    
    
    game.input.onDown.add(vorSchuss, this);
    
    
    //me.timer = game.time.events.loop(2000, me.addPlatform, me);


    var x = game.rnd.integerInRange(game.width, game.world.width - game.width);

        booster =this.game.add.sprite(500, game.height-500, 'star');

        booster.body.collideWorldBounds = false;
        booster.body.immovable = true;

 
}


 
    
    


function bodenBeruehren() {

        if (bullet.body.velocity.x >=100&&bullet.body.velocity.y >=100){
        bullet.body.velocity.x -= 100;
        
        bullet.angle = bullet.body.velocity.x;
        }
                 

        }

function overlapBeanbag(){
    bullet.velocity.x=bullet.velocity.x/2;
}

    
    
    
function vorSchuss(){
         bullet.reset(this.gun.x, this.gun.y);
         bullet.alive = true;
         bullet.checkWorldBounds = true;
         bullet.outOfBoundsKill = false;
         bullet.rotation=this.game.physics.arcade.angleToPointer(this.gun);
         game.camera.follow(bullet);

         if(bullet.body.velocity.y==0){

         powerBar = game.add.sprite(this.gun.x,this.gun.y-100,'platform');
         powerBar.width = 0;
         powerTween = game.add.tween(powerBar).to({width: 100 }, 1000, Phaser.Easing.Linear.None,true);
         game.input.onDown.remove(vorSchuss, this);
         game.input.onUp.add(schuss, this);
          }
         }

function schuss(){
          bulletSpeed= -powerBar.width*3-100
          powerBar.destroy();
          game.tweens.removeAll();
         

          powerTween.stop();
          game.physics.arcade.moveToPointer(bullet, 100);
          bullet.body.velocity.x += -bulletSpeed*2;
          bullet.body.velocity.y += bulletSpeed*2;

          game.input.onUp.remove(schuss, this);
          
    
    
          }

function collectBooster (bullet, booster){
    booster.kill();
    bullet.body.acceleration =+ 400;
}



function generateBooster () {
        /*boosters = game.add.group();
        boosters.enableBody = true;
        var numBooster = game.rnd.integerInRange(0,5)*/
       
        var x = game.rnd.integerInRange(game.width, game.world.width - game.width);
   boosters = game.add.group();
     boosters.enableBody = true; 
         while(!boosters.alive){
    var booster = boosters.create(x, game.height-250, 'star');
    this.game.physics.enable(boosters, Phaser.Physics.ARCADE) ; 
     booster.body.collideWorldBounds = false;
     booster.body.immovable = true;
    booster.body.allowGravity = false;
         }
   }
    


function update() {
   
    game.physics.arcade.collide(bullet, groundBlock, bodenBeruehren);
    game.physics.arcade.overlap(bullet, generateBooster.boosters, collectBooster);
    game.physics.arcade.collide(bullet, beanbags, overlapBeanbag);
    

    bullet.angle += 1;


    this.game.world.bringToTop(this.gun);
    this.gun2.rotation = this.game.physics.arcade.angleToPointer(this.gun);
    if (bullet.x>600){bg.autoScroll(-bullet.body.velocity.x,0);}
    
    

    /*if (bullet.alive){


        while(!booster.alive){
        generateBooster();
        }
    }*/

    //if (this.game.input.activePointer.isDown) {
        //this.shootBullet();
    
    //}

    //if (bullet.alive){ 
    //    generateBooster();   
    //}
  

 
    
  


    //if (bullet.checkWorldBounds = true){
    //bg.reset(this.bg.x, this.bg.y);
    //groundBlock.reset(this.groundBlock.x, this.groundBlock.y);

}

function render() {

    
        game.debug.bodyInfo(bullet, 32, 64);

}




</script>

</body>
</html>